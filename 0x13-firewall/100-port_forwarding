#!/bin/bash

# Enable IP forwarding
sudo sed -i 's/^#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/ufw/sysctl.conf
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

# Backup before.rules file
sudo cp /etc/ufw/before.rules /etc/ufw/before.rules.bak

# Insert NAT rule at the beginning of before.rules
sudo sed -i '1i \
# Redirect TCP port 8080 to 80\n*nat\n:PREROUTING ACCEPT [0:0]\n-A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80\nCOMMIT\n' /etc/ufw/before.rules

# Allow necessary ports
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8080/tcp

# Enable and reload UFW
sudo ufw --force enable
sudo ufw reload

# Display status
sudo ufw status verbose

# Verify forwarding rule
sudo iptables -t nat -L -n -v
