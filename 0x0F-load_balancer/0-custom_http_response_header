#!/usr/bin/env bash
# Set up Nginx with custom header and redirect

sudo apt-get update
sudo apt-get -y install nginx

# Allow HTTP through firewall
sudo ufw allow 'Nginx HTTP'

# Ensure basic web root exists
sudo mkdir -p /var/www/html
sudo chmod -R 755 /var/www
echo 'Hello World!' | sudo tee /var/www/html/index.html

# Clean previous edits if re-running
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak

# Insert X-Served-By header in main location and redirect
sudo sed -i '/server_name _;/a \
\tlocation / {\n\
\t\tadd_header X-Served-By \$hostname;\n\
\t}\n\
\n\
\tlocation = /redirect_me {\n\
\t\tadd_header X-Served-By \$hostname;\n\
\t\treturn 301 https://www.blog.ehoneahobed.com;\n\
\t}' /etc/nginx/sites-available/default

# Restart Nginx
sudo service nginx restart
